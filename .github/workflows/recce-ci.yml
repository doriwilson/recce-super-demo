# GitHub Actions workflow for Recce Cloud CI
# 
# This workflow integrates Recce Cloud into your CI/CD pipeline.
# It automatically validates dbt model changes on every PR.
#
# SETUP INSTRUCTIONS:
# 1. Ensure your GitHub account is connected to Recce Cloud
# 2. Add RECCE_API_KEY as a GitHub secret (Settings > Secrets and variables > Actions)
#    - Get your API key from Recce Cloud: https://cloud.recce.dev/settings/api-keys
# 3. Optionally set RECCE_PROJECT_ID if you have multiple projects
#
# For more details, see: https://docs.recce.dev/guides/ci-cd/github

name: Recce Cloud CI Validation

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  recce-validation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for comparisons
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Set up dbt profiles
        run: |
          mkdir -p ~/.dbt
          cp profiles.yml.example ~/.dbt/profiles.yml
      
      - name: Install dbt packages
        run: dbt deps
      
      - name: Seed database
        run: dbt seed
      
      - name: Build baseline (main branch)
        id: baseline
        run: |
          git checkout main || git checkout ${{ github.base_ref }}
          dbt build
          dbt compile
          # Save artifacts as baseline
          mkdir -p baseline
          cp target/manifest.json baseline/
          cp target/run_results.json baseline/
          echo "baseline_commit=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
      
      - name: Build PR branch
        run: |
          git checkout ${{ github.head_ref || github.ref_name }}
          dbt build
          dbt compile
      
      - name: Run Recce Cloud comparison
        env:
          RECCE_API_KEY: ${{ secrets.RECCE_API_KEY }}
          RECCE_PROJECT_ID: ${{ secrets.RECCE_PROJECT_ID }}
        run: |
          # Run Recce Cloud comparison
          # When RECCE_API_KEY is set, Recce will automatically use Recce Cloud
          # This will:
          # 1. Upload baseline artifacts to Recce Cloud
          # 2. Upload PR branch artifacts
          # 3. Run comparison and get results
          # 4. Post results as PR comment (if configured)
          
          # Set Recce Cloud environment variables
          export RECCE_API_KEY="${{ secrets.RECCE_API_KEY }}"
          [ -n "${{ secrets.RECCE_PROJECT_ID }}" ] && export RECCE_PROJECT_ID="${{ secrets.RECCE_PROJECT_ID }}"
          
          # Run Recce with Cloud integration
          recce run \
            --baseline-manifest baseline/manifest.json \
            --baseline-run-results baseline/run_results.json \
            --target-manifest target/manifest.json \
            --target-run-results target/run_results.json \
            --output-format json \
            --output recce-results.json || true
          
          # If Recce Cloud is configured, it will automatically:
          # - Upload artifacts
          # - Create comparison
          # - Post PR comment (via Recce Cloud webhook)
      
      - name: Fallback: Local Recce comparison
        if: failure()
        run: |
          # If Recce Cloud fails, fall back to local comparison
          echo "⚠️ Recce Cloud unavailable, running local comparison..."
          recce run \
            --baseline-manifest baseline/manifest.json \
            --baseline-run-results baseline/run_results.json \
            --target-manifest target/manifest.json \
            --target-run-results target/run_results.json \
            --output-format json \
            --output recce-results.json || true
      
      - name: Upload Recce results (fallback)
        if: always() && failure()
        uses: actions/upload-artifact@v4
        with:
          name: recce-results
          path: recce-results.json
      
      - name: Comment PR with results (fallback)
        if: always() && failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let results = '## ⚠️ Recce Cloud Unavailable\n\nRunning local Recce comparison instead.';
            try {
              const data = fs.readFileSync('recce-results.json', 'utf8');
              const json = JSON.parse(data);
              results = `## Recce Validation Results (Local)\n\n` +
                       `- Breaking Changes: ${json.breaking_changes?.length || 0}\n` +
                       `- Value Diffs: ${json.value_diffs?.length || 0}\n` +
                       `- Profile Diffs: ${json.profile_diffs?.length || 0}\n\n` +
                       `**Note:** This is a local comparison. For full Recce Cloud features, ensure RECCE_API_KEY is configured.\n\n` +
                       `See full results in workflow artifacts.`;
            } catch (e) {
              results = 'Recce validation completed. Check workflow logs for details.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: results
            });

